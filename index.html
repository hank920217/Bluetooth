<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BLE 控制器</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        button { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-connect { background: #007bff; color: white; }
        .btn-send { background: #28a745; color: white; }
        input { width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #status { font-size: 0.9rem; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ESP32 訊息發送</h2>
    <button class="btn-connect" onclick="connectBle()">1. 連接藍牙裝置</button>
    <hr>
    <input type="text" id="msgInput" placeholder="輸入要傳送的文字..." value="Hello ESP32">
    <button class="btn-send" onclick="sendData()" id="sendBtn" disabled>2. 發送訊息</button>
    <div id="status">狀態: 尚未連線</div>
</div>

<script>
let device = null;
let server = null;
let characteristic = null;

function setStatus(text) {
  document.getElementById("status").innerText = text;
}

function onDisconnected() {
  characteristic = null;
  document.getElementById("sendBtn").disabled = true;
  setStatus("已斷線");
}

// =====================
// 連線
// =====================
async function connectBle() {
  try {
    setStatus("搜尋 ESP 裝置中...");

    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "ESP" }],
      acceptAllDevices: false
    });

    device.addEventListener("gattserverdisconnected", onDisconnected);

    setStatus("連線中: " + (device.name || "ESP"));
    server = await device.gatt.connect();

    characteristic = await findWritableCharacteristic(server);

    document.getElementById("sendBtn").disabled = false;
    setStatus("已連線: " + (device.name || "ESP") + " / 已找到可寫通道");

  } catch (error) {
    console.error(error);
    setStatus("錯誤: " + error.message);
  }
}

// =====================
// 找可寫 characteristic（核心邏輯）
// =====================
async function findWritableCharacteristic(server) {
  const services = await server.getPrimaryServices();

  for (const service of services) {
    const chars = await service.getCharacteristics();

    for (const ch of chars) {
      const props = ch.properties;

      if (props.write || props.writeWithoutResponse) {
        console.log("找到可寫 characteristic:", ch.uuid);
        return ch;
      }
    }
  }

  throw new Error("找不到可寫入的 BLE characteristic");
}

// =====================
// 發送資料
// =====================
async function sendData() {
  if (!characteristic) return;

  const msg = document.getElementById("msgInput").value.trim();
  if (!msg) return;

  const data = new TextEncoder().encode(msg);

  try {
    if (characteristic.writeValueWithResponse) {
      await characteristic.writeValueWithResponse(data);
    } else {
      await characteristic.writeValue(data);
    }

    alert("已發送: " + msg);

  } catch (error) {
    alert("發送失敗: " + error.message);
  }
}
</script>
</body>
</html>
