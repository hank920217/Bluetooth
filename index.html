<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>閃燈控制器</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        button { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-connect { background: #007bff; color: white; }
        .btn-send { background: #28a745; color: white; }
        .preset-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
        .btn-preset { background: #ff9800; color: white; margin: 0; }
        input { width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #status { font-size: 0.9rem; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>訊息發送1</h2>
    <button class="btn-connect" onclick="connectBle()">1. 連接藍牙裝置</button>
    <hr>
    <input type="text" id="msgInput" placeholder="輸入要傳送的文字..." value="Hello ESP32">
    <button class="btn-send" onclick="sendData()" id="sendBtn" disabled>2. 發送訊息</button>
    <div class="preset-group">
      <button class="btn-preset" onclick="sendPreset(1)" id="flash1Btn" disabled>閃一下</button>
      <button class="btn-preset" onclick="sendPreset(2)" id="flash2Btn" disabled>閃兩下</button>
      <button class="btn-preset" onclick="sendPreset(3)" id="flash3Btn" disabled>閃三下</button>
    </div>
    <div id="status">狀態: 尚未連線</div>
</div>

<script>
  let device = null, server = null, characteristic = null;

  const SERVICE_UUID = '000000ff-0000-1000-8000-00805f9b34fb';
  const CHARACTERISTIC_UUID = '0000ff01-0000-1000-8000-00805f9b34fb';

  function setStatus(text) {
    document.getElementById('status').innerText = text;
  }

  function setButtonsDisabled(disabled) {
    document.getElementById('sendBtn').disabled = disabled;
    document.getElementById('flash1Btn').disabled = disabled;
    document.getElementById('flash2Btn').disabled = disabled;
    document.getElementById('flash3Btn').disabled = disabled;
  }

  async function writeMessage(msg) {
    if (!characteristic) return;

    const data = new TextEncoder().encode(msg);
    if (characteristic.writeValueWithResponse) {
      await characteristic.writeValueWithResponse(data);
    } else {
      await characteristic.writeValue(data);
    }
  }

  async function connectBle() {
    try {
      setStatus('正在搜尋裝置...');
      device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'maho' }],
        optionalServices: [SERVICE_UUID]
      });

      device.addEventListener('gattserverdisconnected', () => {
        characteristic = null;
        setButtonsDisabled(true);
        setStatus('已斷線');
      });

      server = await device.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

      setButtonsDisabled(false);
      setStatus('連線成功: ' + (device.name || 'maho'));
    } catch (error) {
      console.error(error);
      setStatus('錯誤: ' + error.message);
    }
  }

  async function sendData() {
    if (!characteristic) return;
    const msg = document.getElementById('msgInput').value.trim();
    if (!msg) return;

    try {
      await writeMessage(msg);
      alert('已發送: ' + msg);
    } catch (error) {
      alert('發送失敗: ' + error.message);
    }
  }

  async function sendPreset(number) {
    if (!characteristic) return;

    try {
      await writeMessage(String(number));
      setStatus('已發送數字: ' + number);
    } catch (error) {
      alert('發送失敗: ' + error.message);
    }
  }
</script>

</body>
</html>
